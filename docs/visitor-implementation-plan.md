# VelocityAstVisitor Implementation Plan

## Overview

The `VelocityAstVisitor` class is responsible for converting the Concrete Syntax Tree (CST) generated by the Chevrotain parser into an Abstract Syntax Tree (AST) that matches the structure expected by the existing Velocity.js implementation. This document outlines the plan for implementing all the required visitor methods.

## Current Status

- [x] Basic visitor infrastructure implemented
- [x] Support for simple content parsing
- [x] Support for variable references
- [x] Support for formal references (e.g., `${name}`)
- [x] Support for property access (e.g., `$user.name`)
- [x] Position information for AST nodes
- [x] Added token definitions for all comparison operators (==, !=, >, <, >=, <=)
- [x] Added token definitions for logical operators (&& and ||)
- [x] Added token definitions for arithmetic operators (+, -, \*, /, %)
- [x] Basic tests for tokenization of all supported operators
- [x] Parser rule and visitor implementation for equality operator (==)
- [ ] Parser rules for other comparison operators (!=, >, <, >=, <=)
- [ ] Parser rules for logical operators (&& and ||)
- [ ] Parser rules for arithmetic operators (+, -, \*, /, %)

## Implementation Plan

### Phase 1: Core Expression Support

- [x] Token definitions for comparison operators
- [x] Token definitions for logical operators
- [x] Token definitions for arithmetic operators
- [x] Parser rule for equality operator
- [x] Visitor method for equality comparison
- [ ] **Next Step:** Parser rules for remaining comparison operators (!=, >, <, >=, <=)
- [ ] Visitor methods for remaining comparison expressions
- [ ] Parser rules for logical operations (AND, OR, NOT)
- [ ] Visitor methods for logical expressions
- [ ] Parser rules for arithmetic operations
- [ ] Visitor methods for arithmetic expressions
- [ ] Support for method call expressions
- [ ] Support for function call expressions

### String Literal Handling

In the current implementation, there is a difference between Jison and Chevrotain in handling string literals:

1. **Jison Parser:** Strips quotes from string literals in the AST (e.g., `"test"` becomes `test`)
2. **Chevrotain Parser:** Preserves quotes in string literals (e.g., `"test"` remains `"test"`)

For compatibility, we should:

- Either strip quotes in the visitor when building the AST
- Or handle both formats in the runtime code that uses the AST

The current solution for testing is to acknowledge the difference and adjust tests accordingly, but for proper implementation, we should align with the Jison format by stripping quotes.

### Implementation Order for Parser Rules

We'll implement the parser rules in this specific order:

1. **Comparison Operators:**

   - Not equal (`!=`) - Highest priority as it builds directly on the equality operator
   - Greater than (`>`)
   - Less than (`<`)
   - Greater than or equal (`>=`)
   - Less than or equal (`<=`)

2. **Logical Operators:**

   - NOT (`!`) - Unary operator
   - AND (`&&`) - Binary operator with higher precedence
   - OR (`||`) - Binary operator with lower precedence

3. **Arithmetic Operators (by precedence groups):**
   - Multiplicative operators (`*`, `/`, `%`)
   - Additive operators (`+`, `-`)

For each group, we'll:

1. Update parser rules to handle the syntax
2. Implement visitor methods to build the corresponding AST nodes
3. Add tests comparing with Jison parsing results
4. Document limitations and differences

### Phase 2: Directive Implementation

- [ ] Implement #set directive visitor
- [ ] Implement conditional directives (#if, #elseif, #else)
- [ ] Implement loop directives (#foreach)
- [ ] Implement macro directives (#macro)

### Phase 3: Advanced Features

- [ ] Handle comments
- [ ] Implement #include and #parse directives
- [ ] Implement #break and #stop directives

## Known Limitations

- Current lexer has issues with handling certain operator combinations
- Closing parenthesis are not correctly tokenized in complex expressions
- Multiple Equal tokens are generated for '==' instead of a single DoubleEqual token
- Logical operations (&&, ||) cannot be properly parsed within complex expressions
- Arithmetic operations (+, -, \*, /, %) do not work properly within complex expressions
- String literals retain quotes in the Chevrotain AST, unlike the Jison AST

## Technical Considerations

### Visitor Method Structure

Each visitor method should:

1. Extract information from CST nodes
2. Create appropriate AST nodes
3. Preserve position information
4. Handle nested structures recursively

### Position Information

Position information is critical for error reporting and should be preserved in all AST nodes:

```typescript
{
  first_line: number;
  last_line: number;
  first_column: number;
  last_column: number;
}
```

### AST Compatibility

The AST structure must match the existing format used by the Jison parser for backward compatibility.

## Testing Strategy

- Create test cases for each visitor method
- Compare outputs with the Jison parser
- Verify that position information is correct
- Ensure nested structures are handled properly

## Implementation Order

1. Complete core expression support (comparison, logical, arithmetic operators)
2. Implement #set directive visitor
3. Implement conditional directive visitors
4. Implement loop directive visitors
5. Add support for advanced features

## Resources

- [AST Node Definitions](src/parse/chevrotain/types/ast-nodes.ts)
- [Original Jison Parser](src/parse/velocity.js)
- [Test Cases](src/parse/chevrotain/__tests__/parser.test.ts)
- [Chevrotain Visitor Documentation](https://chevrotain.io/docs/guide/concrete_syntax_tree.html#cstvisitor)
