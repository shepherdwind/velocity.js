# VelocityAstVisitor Implementation Plan

## Overview

The `VelocityAstVisitor` class is responsible for converting the Concrete Syntax Tree (CST) generated by the Chevrotain parser into an Abstract Syntax Tree (AST) that matches the structure expected by the existing Velocity.js implementation. This document outlines the plan for implementing all the required visitor methods.

## Current Status

- [x] Basic visitor infrastructure implemented
- [x] Support for simple content parsing
- [x] Support for variable references
- [x] Support for formal references (e.g., `${name}`)
- [x] Support for property access (e.g., `$user.name`)
- [x] Position information for AST nodes
- [x] Added support for comparison operators (==, !=, >, <, >=, <=)
- [x] Added basic lexical support for logical operators (&& and ||)
- [x] Added basic lexical support for arithmetic operators (+, -, \*, /, %)

## Implementation Plan

### Phase 1: Core Expression Support

- [x] Token definitions for comparison operators
- [x] Token definitions for logical operators
- [x] Token definitions for arithmetic operators
- [ ] Parser rules for binary expressions
- [ ] Visitor methods for comparison expressions
- [ ] Visitor methods for logical expressions
- [ ] Visitor methods for arithmetic expressions
- [ ] Support for method call expressions
- [ ] Support for function call expressions

### Phase 2: Directive Implementation

- [ ] Implement #set directive visitor
- [ ] Implement conditional directives (#if, #elseif, #else)
- [ ] Implement loop directives (#foreach)
- [ ] Implement macro directives (#macro)

### Phase 3: Advanced Features

- [ ] Handle comments
- [ ] Implement #include and #parse directives
- [ ] Implement #break and #stop directives

## Known Limitations

- Current lexer has issues with handling certain operator combinations
- Closing parenthesis are not correctly tokenized in complex expressions
- Multiple Equal tokens are generated for '==' instead of a single DoubleEqual token
- Logical operations (&&, ||) cannot be properly parsed within complex expressions
- Arithmetic operations (+, -, \*, /, %) do not work properly within complex expressions

## Technical Considerations

### Visitor Method Structure

Each visitor method should:

1. Extract information from CST nodes
2. Create appropriate AST nodes
3. Preserve position information
4. Handle nested structures recursively

### Position Information

Position information is critical for error reporting and should be preserved in all AST nodes:

```typescript
{
  first_line: number;
  last_line: number;
  first_column: number;
  last_column: number;
}
```

### AST Compatibility

The AST structure must match the existing format used by the Jison parser for backward compatibility.

## Testing Strategy

- Create test cases for each visitor method
- Compare outputs with the Jison parser
- Verify that position information is correct
- Ensure nested structures are handled properly

## Implementation Order

1. Complete core expression support (comparison, logical, arithmetic operators)
2. Implement #set directive visitor
3. Implement conditional directive visitors
4. Implement loop directive visitors
5. Add support for advanced features

## Resources

- [AST Node Definitions](src/parse/chevrotain/types/ast-nodes.ts)
- [Original Jison Parser](src/parse/velocity.js)
- [Test Cases](src/parse/chevrotain/__tests__/parser.test.ts)
- [Chevrotain Visitor Documentation](https://chevrotain.io/docs/guide/concrete_syntax_tree.html#cstvisitor)
