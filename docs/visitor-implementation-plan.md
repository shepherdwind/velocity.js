# VelocityAstVisitor Implementation Plan

## Overview

The `VelocityAstVisitor` class is responsible for converting the Concrete Syntax Tree (CST) generated by the Chevrotain parser into an Abstract Syntax Tree (AST) that is compatible with the existing system. This document outlines the plan for completing the visitor implementation.

## Current Status

Basic visitor functionality has been implemented, with support for:

- [x] Simple content (raw text)
- [x] Variable references (`$var`)
- [x] Formal references (`${var}`)
- [x] Property access (`$var.prop`)
- [x] Position information for AST nodes

## Implementation Plan

### Phase 1: Core Expression Support

- [ ] Enhance condition support

  - [x] Basic equality conditions (`$a == $b` or `$a == "string"`)
  - [ ] Implement other comparison operators (`!=`, `>`, `<`, `>=`, `<=`)
  - [ ] Support for logical operators (`&&`, `||`, `!`)
  - [ ] Support for arithmetic expressions (`+`, `-`, `*`, `/`, `%`)

- [ ] Method and function calls
  - [ ] Method calls with arguments (`$obj.method(arg1, arg2)`)
  - [ ] Function calls (`$function(arg1, arg2)`)
  - [ ] Chain calls (`$obj.method1().method2()`)

### Phase 2: Directive Implementation

- [ ] Set directive (`#set($var = value)`)

  - [x] Basic variable assignment
  - [ ] Support for complex expressions
  - [ ] Support for array/map literals

- [ ] Conditional directives

  - [ ] `#if` directive with full condition support
  - [ ] `#elseif` directive
  - [ ] `#else` directive
  - [ ] Proper handling of `consequent` and `alternate` blocks

- [ ] Loop directives

  - [ ] `#foreach` directive
  - [ ] Proper tracking of iteration item and collection
  - [ ] Support for loop body as a block

- [ ] Macro directives
  - [ ] `#macro` definition
  - [ ] Macro parameter handling
  - [ ] Macro call support

### Phase 3: Advanced Features

- [ ] Comment handling (`## comment`)
- [ ] Include directive (`#include('template.vm')`)
- [ ] Parse directive (`#parse('template.vm')`)
- [ ] Define/evaluate directives
- [ ] Break directive (`#break`)
- [ ] Stop directive (`#stop`)

## Technical Considerations

### Visitor Method Structure

Each visitor method should follow this general pattern:

```typescript
methodName(ctx: Record<string, unknown[]>): AstNode {
  // Extract required information from context
  const relevantData = extractFromContext(ctx);

  // Create the appropriate AST node
  const node = createAstNode(relevantData);

  // Set position information
  node.pos = this.buildPosition(ctx);

  // Process child nodes if necessary
  if (ctx.childRule) {
    node.children = ctx.childRule.map(child => this.visit(child));
  }

  return node;
}
```

### Position Information

Position tracking is essential for error reporting and source mapping. The visitor should maintain consistent position information across all node types:

- Use `buildPosition` method for standard nodes
- Use `buildVariableRefPosition` for variable references to match Jison behavior
- Ensure position information includes `first_line`, `first_column`, `last_line`, and `last_column`

### AST Compatibility

All generated nodes must be compatible with the existing AST structure:

- Follow the existing type definitions in `parser.ts`
- Match the structure expected by AST consumers
- Ensure field names and values match Jison parser output

## Testing Strategy

For each visitor method implementation:

1. Create test cases with specific inputs
2. Compare output against Jison parser
3. Verify structure matches expected result
4. Test edge cases and error conditions

Use the pattern established in `parser.test.ts`, with assertion of specific properties rather than direct object comparison.

## Implementation Order

To maximize progress while maintaining stability:

1. Complete expression support first, as other features depend on it
2. Implement directives in order of complexity (set, if, foreach, macro)
3. Add advanced features once core functionality is stable

## Resources

- AST node definitions in `src/parse/chevrotain/parser.ts`
- Original Jison parser in `src/parse/index.js`
- Test cases in `src/parse/chevrotain/__tests__/parser.test.ts`
- Chevrotain visitor documentation: https://chevrotain.io/docs/guide/concrete_syntax_tree.html#cst-visitor
